# SciPy using all SBOM sources

This example illustrates the proposal to redefine the location of SBOMs in wheels from only using `Sbom-File`
to using `.dist-info/sboms/` to avoid the use of `dynamic` for SBOMs that are generated by the build backend.

SciPy represents a project which uses every kind of SBOM source:

* Statically defined source SBOMs for [vendored projects](https://scipy.github.io/devdocs/dev/core-dev/index.html#vendored-code).
* Dynamically generated SBOMs based on the [build configuration in Meson](https://docs.scipy.org/doc/scipy/building/compilers_and_options.html).
* Post-build appended SBOMs from [repairing system libraries into the wheel with Auditwheel](https://docs.scipy.org/doc/scipy/building/redistributable_binaries.html).

## Source SBOMs for vendored code

These SBOMs would be checked in to version control and specified using
the `project.sbom-files` key in `pyproject.toml`:

```toml
[project]
name = "scipy"
version = "1.16.0"
...
sbom-files = [
    "scipy/_lib/scipy-vendored.cdx.json"
    # or "scipy/_lib/*.cdx.json" to glob
    # if using "one-project-per-SBOM"
]
```

This SBOM would describe the vendored projects:

```json
{
  "components": [
    {
      "bom-ref": "https://github.com/stevengj/nlopt",
      "name": "DIRECT",
      "version": "2.10.0",
      "type": "library"
    },
    ...
}
```

When building a source distribution the metadata would look like so:

```editorconfig
Name: scipy
Version: 1.16.0
...
Sbom-File: scipy/_lib/scipy-vendored.cdx.json
```

## Building the wheel

Meson allows configuring many options, including which compilers and optional features
are used in the build. An SBOM can record these options and the list of tools used to
build different libraries. This results in another SBOM, but because this one isn't
static it's placed into `.dist-info/sboms` without a metadata entry.

```editorconfig
# Source SBOM files moved to '.dist-info/sboms'
# to maintain the validity of 'Sbom-File: scipy/_lib/direct.cdx.json'
scipy.dist-info/sboms/scipy/_lib/scipy-vendored.cdx.json
# Mesonpy generates a new SBOM file for '.dist-info/sboms':
scipy.dist-info/sboms/mesonpy.cdx.json     
scipy.dist-info/METADATA
scipy.dist-info/RECORD
scipy/...                                           
...
```

Metadata is unchanged from the source distribution:

```editorconfig
Name: scipy
Version: 1.16.0
...
Sbom-File: scipy/_lib/scipy-vendored.cdx.json
```

## Repairing with system libraries

Now the wheel is prepared for distribution by repairing with auditwheel:

```terminal
$ auditwheel repair dist/*.whl
```

This bundles three system libraries for scipy into the wheel:

* `libquadmath.so` (provided by `pkg:deb/ubuntu/libquadmath0@12.3.0-1ubuntu1~22.04`)
* `libgfortran.so` (provided by `pkg:deb/ubuntu/libgfortran5@12.3.0-1ubuntu1~22.04`)
* `libopenblas-r0.so` (provided by `pkg:deb/ubuntu/libopenblas0-pthread@0.3.20%2Bds-1`)

Auditwheel writes an SBOM describing these bundled libraries and adds it to `scipy.dist-info/sboms`.
Again, no `Sbom-File` metadata is added.

```json
{
  "components": [
    {
      "bom-ref": "pkg:deb/ubuntu/libquadmath0@12.3.0-1ubuntu1~22.04",
      "name": "libquadmath",
      "version": "12.3.0-1ubuntu1~22.04",
      "purl": "pkg:deb/ubuntu/libquadmath0@12.3.0-1ubuntu1~22.04"
    },
    {
      "bom-ref": "pkg:deb/ubuntu/libgfortran5@12.3.0-1ubuntu1~22.04",
      "name": "libgfortran",
      "version": "12.3.0-1ubuntu1~22.04",
      "purl": "pkg:deb/ubuntu/libgfortran5@12.3.0-1ubuntu1~22.04"
    },
    {
      "bom-ref": "pkg:deb/ubuntu/libopenblas0-pthread@0.3.20%2Bds-1",
      "name": "libopenblas0-pthread",
      "version": "0.3.20+ds-1",
      "purl": "pkg:deb/ubuntu/libopenblas0-pthread@0.3.20%2Bds-1"
    },
  ]
}
```

The final wheel archive looks like so:

```
# Wheel archive
scipy.dist-info/sboms/scipy/_lib/scipy-vendored.cdx.json
scipy.dist-info/sboms/mesonpy.cdx.json
scipy.dist-info/sboms/auditwheel.cdx.json
scipy.dist-info/METADATA
scipy.dist-info/RECORD
scipy/...  
```

And the `METADATA`:

```editorconfig
Name: scipy
Version: 1.16.0
...
Sbom-File: scipy/_lib/scipy-vendored.cdx.json
# Note: No meson or auditwheel SBOMs referenced here.
```

## Discovering SBOMs from source distributions

For a tool inspecting a source distribution for SBOM files, the tool would use
the `METADATA` file looking for `Sbom-File` entries:

```editorconfig
Sbom-File: scipy/_lib/scipy-vendored.cdx.json
```

and would find:

- `scipy/_lib/scipy-vendored.cdx.json`

## Discovering SBOMs from wheels

For a tool inspecting a wheel for SBOMs, the tool would inspect the `.dist-info/sboms` directory:

```
scipy.dist-info/sboms/scipy/_lib/scipy-vendored.cdx.json
scipy.dist-info/sboms/meson/build.spdx.json
scipy.dist-info/sboms/auditwheel.cdx.json
```

and would find:

- `scipy.dist-info/sboms/scipy/_lib/scipy-vendored.cdx.json`
- `scipy.dist-info/sboms/meson/build.spdx.json`
- `scipy.dist-info/sboms/auditwheel.cdx.json`

Note that the tool can't use `METADATA` to discover SBOMs in wheels, as those
keys only list the **source SBOM files**, not all SBOMs from both the source and build phases.
